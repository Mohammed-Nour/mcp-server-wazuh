#!/bin/bash
#===============================================================================
# Attack #05: EICAR Test File (Malware Simulation)
# Category: Malware
# Expected Wazuh Rules: 87103 (lvl3), 87104 (lvl3), 87105 (lvl12)
# Expected Level: 3-12 (observed)
# MITRE ATT&CK: T1105 (Ingress Tool Transfer)
#===============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "${SCRIPT_DIR}/../scripts/config.env" 2>/dev/null || true

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

ATTACK_ID="05"
ATTACK_NAME="EICAR Test File Download"
ATTACK_CATEGORY="Malware"

TARGET="${1:-$TARGET_IP}"

echo "==============================================================================="
echo -e "${YELLOW}ATTACK #${ATTACK_ID}: ${ATTACK_NAME}${NC}"
echo "==============================================================================="
echo "Target: $TARGET"
echo "Category: $ATTACK_CATEGORY"
echo ""
echo "The EICAR test file is a safe, industry-standard test file"
echo "used to verify antivirus/malware detection capabilities."
echo ""

START_TIME=$(date +%s.%N)
START_TIMESTAMP=$(date -Iseconds)

echo -e "${GREEN}[*] Attack started at: $START_TIMESTAMP${NC}"
echo ""

ATTACK_COMMANDS='
#!/bin/bash
echo "[*] EICAR test file malware simulation..."

# EICAR test string - this is a SAFE test file, not actual malware
# Standard EICAR test string
EICAR_STRING="X5O!P%@AP[4\PZX54(P^)7CC)7}\$EICAR-STANDARD-ANTIVIRUS-TEST-FILE!\$H+H*"

# Method 1: Create EICAR file directly
echo "[*] Creating EICAR test file in /tmp..."
echo "$EICAR_STRING" > /tmp/eicar.com
echo "$EICAR_STRING" > /tmp/eicar.txt
echo "$EICAR_STRING" > /tmp/malware_test.exe

# Method 2: Download from official source
echo "[*] Downloading EICAR test files..."
cd /tmp

# Try multiple EICAR sources
curl -s -o eicar_download.com "https://www.eicar.org/download/eicar.com" 2>/dev/null || \
wget -q -O eicar_download.com "https://www.eicar.org/download/eicar.com" 2>/dev/null || \
echo "    Could not download from eicar.org"

curl -s -o eicar_download.txt "https://www.eicar.org/download/eicar.com.txt" 2>/dev/null || \
wget -q -O eicar_download.txt "https://www.eicar.org/download/eicar.com.txt" 2>/dev/null || \
echo "    Could not download txt version"

# Method 3: Create in web directory if exists
if [ -d "/var/www/html" ]; then
    echo "[*] Creating EICAR in web directory..."
    echo "$EICAR_STRING" | sudo tee /var/www/html/eicar.com > /dev/null 2>&1
fi

# Method 4: Create with suspicious names
echo "[*] Creating files with suspicious names..."
echo "$EICAR_STRING" > /tmp/trojan.exe
echo "$EICAR_STRING" > /tmp/virus.bat
echo "$EICAR_STRING" > /tmp/ransomware.dll

# List created files
echo ""
echo "[*] Test files created:"
ls -la /tmp/eicar* /tmp/trojan* /tmp/virus* /tmp/ransomware* /tmp/malware* 2>/dev/null

echo ""
echo "[*] Waiting for detection..."
sleep 10

# Cleanup
echo "[*] Cleaning up test files..."
rm -f /tmp/eicar* /tmp/trojan* /tmp/virus* /tmp/ransomware* /tmp/malware* 2>/dev/null
sudo rm -f /var/www/html/eicar.com 2>/dev/null

echo "[*] Cleanup complete"
'

echo "[*] Commands to run on target agent:"
echo ""
echo "$ATTACK_COMMANDS"


TARGET="${1:-$TARGET_IP}"
SSH_KEY_RAW="${SSH_KEY_OVERRIDE:-${TARGET_SSH_KEY:-$HOME/.ssh/wazuh-agent.pem}}"
SSH_USER="${3:-${TARGET_USER:-ubuntu}}"
SSH_KEY="${SSH_KEY_RAW/#\~/$HOME}"



if [ -n "$SSH_KEY" ] && [ -f "$SSH_KEY" ]; then
    echo "[*] Running attack via SSH using key $SSH_KEY ..."
    ssh -i "$SSH_KEY" -o StrictHostKeyChecking=no "$SSH_USER@$TARGET" "$ATTACK_COMMANDS"
else
    echo -e "${YELLOW}[!] Cannot connect to target. Printing commands to run manually:${NC}"
    echo ""
    echo "--- Run these commands on the target agent ---"
    echo "$ATTACK_COMMANDS"
    echo "--- End of commands ---"
fi

END_TIME=$(date +%s.%N)
END_TIMESTAMP=$(date -Iseconds)
DURATION=$(echo "$END_TIME - $START_TIME" | bc)

echo ""
echo "==============================================================================="
echo -e "${GREEN}[âœ“] Attack script generated${NC}"
echo "==============================================================================="
echo "Start Time: $START_TIMESTAMP"
echo "End Time: $END_TIMESTAMP"
echo ""
echo "Expected Wazuh alerts:"
echo "  - Rule 510: Malware detected"
echo "  - Rule 87105: ClamAV detection (if ClamAV is installed)"
echo "  - Rule 87106: Malware scan detection"
echo "  - Syscheck alerts for suspicious file creation"
echo ""
echo "Note: EICAR test file is completely SAFE and is industry standard"
echo "for testing antivirus/malware detection systems."
echo ""
echo "Data for CSV:"
echo "  attack_id: $ATTACK_ID"
echo "  attack_name: $ATTACK_NAME"
echo "  category: $ATTACK_CATEGORY"
echo "  attack_start_time: $START_TIMESTAMP"
echo "  attack_end_time: $END_TIMESTAMP"
